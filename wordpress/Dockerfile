###############################################################
# Dockerfile generated by Bocker-v1.1. Do not edit this file. #
###############################################################

FROM icy/phpfpm:latest
MAINTAINER Anh K. Huynh <kyanh@theslinux.org>

ENV DEBIAN_FRONTEND noninteractive
ENV WP_VERSION 4.2.2

# Bocker method => __ed_ship
# * The output is /bocker.sh in the result image.
# * List of methods:
#   - ed_apt_clean
#   - ed_apt_purge
#
# | set -eux
# | if [[ -f /bocker.sh ]]; then source /bocker.sh; fi
# | ed_apt_clean () 
# | { 
# |     rm -fv /var/cache/apt/*.bin;
# |     rm -fv /var/cache/apt/archives/*.*;
# |     rm -fv /var/lib/apt/lists/*.*;
# |     apt-get autoclean
# | }
# | ed_apt_purge () 
# | { 
# |     apt-get purge -y --auto-remove $@;
# |     ed_apt_clean
# | }
# | echo '#!/bin/bash' > /bocker.sh
# | echo '# This file is generated by Bocker.' >> /bocker.sh
# | declare -f >> /bocker.sh
# | echo 'if [[ -n "$@" ]]; then $@; fi; ' >> /bocker.sh
# | chmod 755 /bocker.sh
#
RUN echo c2V0IC1ldXgKaWYgW1sgLWYgL2JvY2tlci5zaCBdXTsgdGhlbiBzb3VyY2UgL2JvY2tlci5zaDsgZmkKZWRfYXB0X2NsZWFuICgpIAp7IAogICAgcm0gLWZ2IC92YXIvY2FjaGUvYXB0LyouYmluOwogICAgcm0gLWZ2IC92YXIvY2FjaGUvYXB0L2FyY2hpdmVzLyouKjsKICAgIHJtIC1mdiAvdmFyL2xpYi9hcHQvbGlzdHMvKi4qOwogICAgYXB0LWdldCBhdXRvY2xlYW4KfQplZF9hcHRfcHVyZ2UgKCkgCnsgCiAgICBhcHQtZ2V0IHB1cmdlIC15IC0tYXV0by1yZW1vdmUgJEA7CiAgICBlZF9hcHRfY2xlYW4KfQplY2hvICcjIS9iaW4vYmFzaCcgPiAvYm9ja2VyLnNoCmVjaG8gJyMgVGhpcyBmaWxlIGlzIGdlbmVyYXRlZCBieSBCb2NrZXIuJyA+PiAvYm9ja2VyLnNoCmRlY2xhcmUgLWYgPj4gL2JvY2tlci5zaAplY2hvICdpZiBbWyAtbiAiJEAiIF1dOyB0aGVuICRAOyBmaTsgJyA+PiAvYm9ja2VyLnNoCmNobW9kIDc1NSAvYm9ja2VyLnNoCg== | base64 -d | bash

# Bocker method => ed_wordpress_install_generator
#
# | set -eux
# | if [[ -f /bocker.sh ]]; then source /bocker.sh; fi
# | ed_wordpress_install_generator () 
# | { 
# |     { 
# |         echo "#!/bin/bash";
# |         echo "/bocker.sh ed_wordpress_generate_config"
# |     } > /etc/s.supervisor/wordpress.sh
# | }
# | ed_wordpress_install_generator
#
RUN echo c2V0IC1ldXgKaWYgW1sgLWYgL2JvY2tlci5zaCBdXTsgdGhlbiBzb3VyY2UgL2JvY2tlci5zaDsgZmkKZWRfd29yZHByZXNzX2luc3RhbGxfZ2VuZXJhdG9yICgpIAp7IAogICAgeyAKICAgICAgICBlY2hvICIjIS9iaW4vYmFzaCI7CiAgICAgICAgZWNobyAiL2JvY2tlci5zaCBlZF93b3JkcHJlc3NfZ2VuZXJhdGVfY29uZmlnIgogICAgfSA+IC9ldGMvcy5zdXBlcnZpc29yL3dvcmRwcmVzcy5zaAp9CmVkX3dvcmRwcmVzc19pbnN0YWxsX2dlbmVyYXRvcgo= | base64 -d | bash

# Bocker method => __ed_ship
# * The output is /bocker.sh in the result image.
# * List of methods:
#   - ed_phpfpm_generate_nginx_config
#   - ed_wordpress_generate_config
#   - ed_wordpress_generate_wp_config
#
# | set -eux
# | if [[ -f /bocker.sh ]]; then source /bocker.sh; fi
# | ed_phpfpm_generate_nginx_config () 
# | { 
# |     cat  <<-EOF
# |   # This file was generated for Wordpress/phpfpm.
# |   server {
# |     listen       80;
# |     server_name  ${PHPFPM_DOMAIN} ${PHPFPM_OTHER_DOMAINS:-};
# |     root         /phpfpm/www/;
# | 
# |     index index.php index.html;
# | 
# |     error_log   /var/log/nginx/${PHPFPM_DOMAIN}.error.log;
# |     access_log  /var/log/nginx/${PHPFPM_DOMAIN}.acces.log main;
# | 
# |     include /etc/nginx/misc/security.conf;
# | 
# |     location / {
# |       try_files \$uri \$uri/ /index.php?q=\$uri&\$args;
# |     }
# | 
# |     location ~ \.php$ {
# |       fastcgi_pass     unix:/phpfpm/var/phpfpm.sock;
# |       fastcgi_index    index.php;
# |       fastcgi_param    SCRIPT_FILENAME  /phpfpm/www/\$fastcgi_script_name;
# |       include          /etc/nginx/fastcgi_params;
# |     }
# |   }
# | EOF
# | 
# | }
# | ed_wordpress_generate_config () 
# | { 
# |     export WP_VERSION="${WP_VERSION:-4.2.2}";
# |     export WP_URL="${WP_URL:-https://wordpress.org/wordpress-4.2.2.tar.gz}";
# |     _F_CONFIG="/phpfpm/www/wp-config.php";
# |     if [[ ! -f "$_F_CONFIG" ]]; then
# |         echo ":: $FUNCNAME: Generating configuration '$_F_CONFIG'..." 1>&2;
# |         ed_wordpress_generate_wp_config > $_F_CONFIG;
# |     fi;
# |     if [[ -f "/phpfpm/www/wp-includes/version.php" ]]; then
# |         echo ":: $FUNCNAME: Wordpress does exist in /phpfpm/www/." 1>&2;
# |     else
# |         echo ":: $FUNCNAME: Downloading wordpress from ${WP_URL}..." 1>&2;
# |         curl -Lso- "${WP_URL}" | tar -xzf - --strip-components=1 -C /phpfpm/www/;
# |     fi;
# |     if [[ "${WP_FORCE_CHOWN:-}" == "1" ]]; then
# |         echo ":: $FUNCNAME: WP_FORCE_CHOWN is used to fix owner of all files under /phpfpm/www/" 1>&2;
# |         find /phpfpm/www/ -mindepth 1 -exec chown www-data: {} \;;
# |     fi
# | }
# | ed_wordpress_generate_wp_config () 
# | { 
# |     export WP_DB_NAME="${WP_DB_NAME:-wordpress}";
# |     export WP_DB_USER="${WP_DB_USER:-wordpress}";
# |     export WP_DB_PASSWD="${WP_DB_PASSWD:-wordpress}";
# |     export WP_DB_HOST="${WP_DB_HOST:-db}";
# |     function ed_wordpress_random_64_chars () 
# |     { 
# |         tr -dc '_A-Z-a-z-0-9!@#$%' < /dev/urandom | head -c64;
# |         echo ""
# |     };
# |     cat  <<-EOF
# | <?php
# | 
# | define('DB_NAME',     '${WP_DB_NAME}');
# | define('DB_USER',     '${WP_DB_USER}');
# | define('DB_PASSWORD', '${WP_DB_PASSWD}');
# | define('DB_HOST',     '${WP_DB_HOST}');
# | 
# | define('DB_CHARSET', 'utf8');
# | define('DB_COLLATE', '');
# | 
# | define('AUTH_KEY',         '$(ed_wordpress_random_64_chars)');
# | define('SECURE_AUTH_KEY',  '$(ed_wordpress_random_64_chars)');
# | define('LOGGED_IN_KEY',    '$(ed_wordpress_random_64_chars)');
# | define('NONCE_KEY',        '$(ed_wordpress_random_64_chars)');
# | define('AUTH_SALT',        '$(ed_wordpress_random_64_chars)');
# | define('SECURE_AUTH_SALT', '$(ed_wordpress_random_64_chars)');
# | define('LOGGED_IN_SALT',   '$(ed_wordpress_random_64_chars)');
# | define('NONCE_SALT',       '$(ed_wordpress_random_64_chars)');
# | 
# | \$table_prefix  = 'wp_';
# | 
# | define('WP_DEBUG', false);
# | 
# | if ( !defined('ABSPATH') )
# |   define('ABSPATH', dirname(__FILE__) . '/');
# | 
# | require_once(ABSPATH . 'wp-settings.php');
# | EOF
# | 
# | }
# | echo '#!/bin/bash' > /bocker.sh
# | echo '# This file is generated by Bocker.' >> /bocker.sh
# | declare -f >> /bocker.sh
# | echo 'if [[ -n "$@" ]]; then $@; fi; ' >> /bocker.sh
# | chmod 755 /bocker.sh
#
RUN echo c2V0IC1ldXgKaWYgW1sgLWYgL2JvY2tlci5zaCBdXTsgdGhlbiBzb3VyY2UgL2JvY2tlci5zaDsgZmkKZWRfcGhwZnBtX2dlbmVyYXRlX25naW54X2NvbmZpZyAoKSAKeyAKICAgIGNhdCAgPDwtRU9GCiAgIyBUaGlzIGZpbGUgd2FzIGdlbmVyYXRlZCBmb3IgV29yZHByZXNzL3BocGZwbS4KICBzZXJ2ZXIgewogICAgbGlzdGVuICAgICAgIDgwOwogICAgc2VydmVyX25hbWUgICR7UEhQRlBNX0RPTUFJTn0gJHtQSFBGUE1fT1RIRVJfRE9NQUlOUzotfTsKICAgIHJvb3QgICAgICAgICAvcGhwZnBtL3d3dy87CgogICAgaW5kZXggaW5kZXgucGhwIGluZGV4Lmh0bWw7CgogICAgZXJyb3JfbG9nICAgL3Zhci9sb2cvbmdpbngvJHtQSFBGUE1fRE9NQUlOfS5lcnJvci5sb2c7CiAgICBhY2Nlc3NfbG9nICAvdmFyL2xvZy9uZ2lueC8ke1BIUEZQTV9ET01BSU59LmFjY2VzLmxvZyBtYWluOwoKICAgIGluY2x1ZGUgL2V0Yy9uZ2lueC9taXNjL3NlY3VyaXR5LmNvbmY7CgogICAgbG9jYXRpb24gLyB7CiAgICAgIHRyeV9maWxlcyBcJHVyaSBcJHVyaS8gL2luZGV4LnBocD9xPVwkdXJpJlwkYXJnczsKICAgIH0KCiAgICBsb2NhdGlvbiB+IFwucGhwJCB7CiAgICAgIGZhc3RjZ2lfcGFzcyAgICAgdW5peDovcGhwZnBtL3Zhci9waHBmcG0uc29jazsKICAgICAgZmFzdGNnaV9pbmRleCAgICBpbmRleC5waHA7CiAgICAgIGZhc3RjZ2lfcGFyYW0gICAgU0NSSVBUX0ZJTEVOQU1FICAvcGhwZnBtL3d3dy9cJGZhc3RjZ2lfc2NyaXB0X25hbWU7CiAgICAgIGluY2x1ZGUgICAgICAgICAgL2V0Yy9uZ2lueC9mYXN0Y2dpX3BhcmFtczsKICAgIH0KICB9CkVPRgoKfQplZF93b3JkcHJlc3NfZ2VuZXJhdGVfY29uZmlnICgpIAp7IAogICAgZXhwb3J0IFdQX1ZFUlNJT049IiR7V1BfVkVSU0lPTjotNC4yLjJ9IjsKICAgIGV4cG9ydCBXUF9VUkw9IiR7V1BfVVJMOi1odHRwczovL3dvcmRwcmVzcy5vcmcvd29yZHByZXNzLTQuMi4yLnRhci5nen0iOwogICAgX0ZfQ09ORklHPSIvcGhwZnBtL3d3dy93cC1jb25maWcucGhwIjsKICAgIGlmIFtbICEgLWYgIiRfRl9DT05GSUciIF1dOyB0aGVuCiAgICAgICAgZWNobyAiOjogJEZVTkNOQU1FOiBHZW5lcmF0aW5nIGNvbmZpZ3VyYXRpb24gJyRfRl9DT05GSUcnLi4uIiAxPiYyOwogICAgICAgIGVkX3dvcmRwcmVzc19nZW5lcmF0ZV93cF9jb25maWcgPiAkX0ZfQ09ORklHOwogICAgZmk7CiAgICBpZiBbWyAtZiAiL3BocGZwbS93d3cvd3AtaW5jbHVkZXMvdmVyc2lvbi5waHAiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiOjogJEZVTkNOQU1FOiBXb3JkcHJlc3MgZG9lcyBleGlzdCBpbiAvcGhwZnBtL3d3dy8uIiAxPiYyOwogICAgZWxzZQogICAgICAgIGVjaG8gIjo6ICRGVU5DTkFNRTogRG93bmxvYWRpbmcgd29yZHByZXNzIGZyb20gJHtXUF9VUkx9Li4uIiAxPiYyOwogICAgICAgIGN1cmwgLUxzby0gIiR7V1BfVVJMfSIgfCB0YXIgLXh6ZiAtIC0tc3RyaXAtY29tcG9uZW50cz0xIC1DIC9waHBmcG0vd3d3LzsKICAgIGZpOwogICAgaWYgW1sgIiR7V1BfRk9SQ0VfQ0hPV046LX0iID09ICIxIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIjo6ICRGVU5DTkFNRTogV1BfRk9SQ0VfQ0hPV04gaXMgdXNlZCB0byBmaXggb3duZXIgb2YgYWxsIGZpbGVzIHVuZGVyIC9waHBmcG0vd3d3LyIgMT4mMjsKICAgICAgICBmaW5kIC9waHBmcG0vd3d3LyAtbWluZGVwdGggMSAtZXhlYyBjaG93biB3d3ctZGF0YToge30gXDs7CiAgICBmaQp9CmVkX3dvcmRwcmVzc19nZW5lcmF0ZV93cF9jb25maWcgKCkgCnsgCiAgICBleHBvcnQgV1BfREJfTkFNRT0iJHtXUF9EQl9OQU1FOi13b3JkcHJlc3N9IjsKICAgIGV4cG9ydCBXUF9EQl9VU0VSPSIke1dQX0RCX1VTRVI6LXdvcmRwcmVzc30iOwogICAgZXhwb3J0IFdQX0RCX1BBU1NXRD0iJHtXUF9EQl9QQVNTV0Q6LXdvcmRwcmVzc30iOwogICAgZXhwb3J0IFdQX0RCX0hPU1Q9IiR7V1BfREJfSE9TVDotZGJ9IjsKICAgIGZ1bmN0aW9uIGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMgKCkgCiAgICB7IAogICAgICAgIHRyIC1kYyAnX0EtWi1hLXotMC05IUAjJCUnIDwgL2Rldi91cmFuZG9tIHwgaGVhZCAtYzY0OwogICAgICAgIGVjaG8gIiIKICAgIH07CiAgICBjYXQgIDw8LUVPRgo8P3BocAoKZGVmaW5lKCdEQl9OQU1FJywgICAgICcke1dQX0RCX05BTUV9Jyk7CmRlZmluZSgnREJfVVNFUicsICAgICAnJHtXUF9EQl9VU0VSfScpOwpkZWZpbmUoJ0RCX1BBU1NXT1JEJywgJyR7V1BfREJfUEFTU1dEfScpOwpkZWZpbmUoJ0RCX0hPU1QnLCAgICAgJyR7V1BfREJfSE9TVH0nKTsKCmRlZmluZSgnREJfQ0hBUlNFVCcsICd1dGY4Jyk7CmRlZmluZSgnREJfQ09MTEFURScsICcnKTsKCmRlZmluZSgnQVVUSF9LRVknLCAgICAgICAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnU0VDVVJFX0FVVEhfS0VZJywgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnTE9HR0VEX0lOX0tFWScsICAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnTk9OQ0VfS0VZJywgICAgICAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnQVVUSF9TQUxUJywgICAgICAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnU0VDVVJFX0FVVEhfU0FMVCcsICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnTE9HR0VEX0lOX1NBTFQnLCAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CmRlZmluZSgnTk9OQ0VfU0FMVCcsICAgICAgICckKGVkX3dvcmRwcmVzc19yYW5kb21fNjRfY2hhcnMpJyk7CgpcJHRhYmxlX3ByZWZpeCAgPSAnd3BfJzsKCmRlZmluZSgnV1BfREVCVUcnLCBmYWxzZSk7CgppZiAoICFkZWZpbmVkKCdBQlNQQVRIJykgKQogIGRlZmluZSgnQUJTUEFUSCcsIGRpcm5hbWUoX19GSUxFX18pIC4gJy8nKTsKCnJlcXVpcmVfb25jZShBQlNQQVRIIC4gJ3dwLXNldHRpbmdzLnBocCcpOwpFT0YKCn0KZWNobyAnIyEvYmluL2Jhc2gnID4gL2JvY2tlci5zaAplY2hvICcjIFRoaXMgZmlsZSBpcyBnZW5lcmF0ZWQgYnkgQm9ja2VyLicgPj4gL2JvY2tlci5zaApkZWNsYXJlIC1mID4+IC9ib2NrZXIuc2gKZWNobyAnaWYgW1sgLW4gIiRAIiBdXTsgdGhlbiAkQDsgZmk7ICcgPj4gL2JvY2tlci5zaApjaG1vZCA3NTUgL2JvY2tlci5zaAo= | base64 -d | bash

VOLUME /phpfpm/www/wp-content/

CMD ["/supervisor.sh"]
